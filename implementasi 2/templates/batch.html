{% extends "base.html" %}

{% block title %}Unggah Berkas - Sistem Deteksi Ujaran Kebencian{% endblock %}

{% block header_title %}Hate Speech Detector{% endblock %}
{% block header_subtitle %}Analisis Ujaran Kebencian Batch{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Main Form Card -->
    <div class="row justify-content-center">
        <div class="col-xl-12 col-lg-12">
            <div class="main-card">
                <div class="card-header-custom">
                    <div class="text-center">
                        <h2 class="card-title">
                            <i class="fab fa-twitter me-2"></i> Prediksi Data Batch
                        </h2>
                        <p class="card-subtitle">
                            Analisis multiple teks sekaligus melalui unggah berkas CSV
                        </p>
                    </div>
                </div>
                <div class="card-body-custom">
                    <form action="{{ url_for('cekBatch')}}" method="POST" enctype="multipart/form-data" id="batchForm">
                        {{ form.csrf_token }}
                        
                        <!-- Upload CSV Section - Full Width -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-file-csv"></i>
                                        Unggah Berkas CSV
                                    </label>
                                    <div class="file-input-custom-large" id="fileDropArea">
                                        <div class="file-input-content">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                            <h5 class="text-primary">Drop file di sini atau klik untuk memilih</h5>
                                            <p class="text-muted mb-2">Format: CSV dengan kolom 'tweet' (maksimal 50 baris data)</p>
                                            <input class="form-control-custom d-none" type="file" name="batchSentimen" id="batchSentimen" accept=".csv" required>
                                            <button type="button" class="btn-custom-secondary mt-2" onclick="document.getElementById('batchSentimen').click()">
                                                <i class="fas fa-folder-open me-2"></i>Pilih File CSV
                                            </button>
                                        </div>
                                        <div id="fileName" class="file-name-display mt-3"></div>
                                    </div>
                                    <div class="form-text-custom mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        *Hanya support file CSV dengan maksimal 50 baris data
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Options Section - Below Upload -->
                        <div class="row">
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="form-group option-card">
                                    <label class="form-label">
                                        <i class="fas fa-brain"></i>
                                        Pilih Model
                                    </label>
                                    <select name="model" id="model" class="form-select-custom" required>
                                        <option value="">Pilih Model</option>
                                        <option value="CNN" {% if model == "CNN" %} selected {% endif %}>FuSE-CNN</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 mb-3">
                                <div class="form-group option-card">
                                    <label class="form-label">
                                        <i class="fas fa-expand-alt"></i>
                                        Model Perluasan
                                    </label>
                                    <select name="perluasan" id="perluasan" class="form-select-custom" required>
                                        <option value="">--- Pilih ---</option>
                                        <option value="0" {% if perluasan == "0" %} selected {% endif %}>Tidak</option>
                                        <option value="1" {% if perluasan == "1" %} selected {% endif %}>Iya</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-12 mb-3">
                                <div class="form-group option-card">
                                    <label class="form-label">
                                        <i class="fas fa-cog"></i>
                                        Opsi Tambahan
                                    </label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" name="perluasanKalimat" id="perluasanKalimat" checked>
                                        <label class="form-check-label" for="perluasanKalimat">Perluasan Kalimat</label>
                                    </div>
                                    <div class="form-text-custom-small">
                                        Aktifkan untuk memperluas kalimat otomatis
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="submit" id="prosesSentimen" class="btn-custom-primary me-3">
                                    <i class="fas fa-play-circle me-2"></i> Proses Batch
                                </button>
                                <button type="button" class="btn-custom-secondary" id="clearFormBtn">
                                    <i class="fas fa-eraser me-2"></i> Bersihkan Form
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Results Section -->
                    {% if hasil=='1' %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="result-card">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Hasil Analisis Batch</h4>
                                    {% if download_file %}
                                    <a href="{{ url_for('download_batch', filename=download_file) }}" class="btn-custom-primary">
                                        <i class="fas fa-download me-2"></i>Download Hasil
                                    </a>
                                    {% endif %}
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-custom">
                                        <thead>
                                            <tr>
                                                <th style="width: 30%">Kalimat</th>
                                                <th style="width: 70%">Hasil Prediksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for index in range(dictData['tweet']|length) %}
                                            <tr>
                                                <td class="fw-bold">{{ dictData['normalize'][index] }}</td>
                                                <td>
                                                    <div class="d-flex flex-wrap gap-1">
                                                        {% if dictData['Non_HS'][index] == 1 %}
                                                            <span class="badge-custom badge-success">Bukan Ujaran Kebencian ({{ "{:.0f}%".format(dictData['Non_HS_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        
                                                        {% if dictData['HS'][index] == 1 %}
                                                            <span class="badge-custom badge-danger">Ujaran Kebencian ({{ "{:.0f}%".format(dictData['HS_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        
                                                        {% if dictData['Abusive'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kata Kasar ({{ "{:.0f}%".format(dictData['Abusive_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        
                                                        {% if dictData['HS_individual'][index] == 1 %}
                                                            <span class="badge-custom badge-info">Target - Individu ({{ "{:.0f}%".format(dictData['HS_individual_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Group'][index] == 1 %}
                                                            <span class="badge-custom badge-info">Target - Kelompok ({{ "{:.0f}%".format(dictData['HS_Group_Persen'][index]) }})</span>
                                                        {% endif %}

                                                        {% if dictData['HS_Religion'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kategori - Agama ({{ "{:.0f}%".format(dictData['HS_Religion_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Race'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kategori - Ras ({{ "{:.0f}%".format(dictData['HS_Race_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Physical'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kategori - Fisik ({{ "{:.0f}%".format(dictData['HS_Physical_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Gender'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kategori - Gender ({{ "{:.0f}%".format(dictData['HS_Gender_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Other'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Kategori - Lainnya ({{ "{:.0f}%".format(dictData['HS_Other_Persen'][index]) }})</span>
                                                        {% endif %}

                                                        {% if dictData['HS_Weak'][index] == 1 %}
                                                            <span class="badge-custom badge-info">Level - Lemah ({{ "{:.0f}%".format(dictData['HS_Weak_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Moderate'][index] == 1 %}
                                                            <span class="badge-custom badge-warning">Level - Sedang ({{ "{:.0f}%".format(dictData['HS_Moderate_Persen'][index]) }})</span>
                                                        {% endif %}
                                                        {% if dictData['HS_Strong'][index] == 1 %}
                                                            <span class="badge-custom badge-danger">Level - Kuat ({{ "{:.0f}%".format(dictData['HS_Strong_Persen'][index]) }})</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if error %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error:</strong> {{ error }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Information Card -->
    <div class="row justify-content-center">
        <div class="col-xl-12 col-lg-12">
            <div class="main-card">
                <div class="card-header-custom">
                    <div class="text-center">
                        <h2 class="card-title">
                            <i class="fas fa-info-circle me-2"></i> Ketentuan Penggunaan
                        </h2>
                    </div>
                </div>
                <div class="card-body-custom">
                    <div class="row">
                        <div class="col-md-8 mx-auto text-center">
                            <p class="lead mb-4">
                                Berkas harus berisi <strong>satu kolom</strong> dengan nama <strong>tweet</strong>, 
                                dengan maksimal <strong>50 baris</strong> data.
                            </p>
                            <div class="info-alert">
                                <i class="fas fa-download me-2"></i>
                                <strong>Download Template:</strong> 
                                <a href="https://drive.google.com/file/d/1yF3PqRiEx9Uggccfyj97UOwOLET2s_Bt/view?usp=sharing" 
                                   target="_blank" class="alert-link">Klik di sini untuk mengunduh format CSV</a>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Proses batch membutuhkan waktu lebih lama tergantung jumlah data yang diunggah
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* CSS untuk konsistensi design */
    .card-header-custom {
        background-color: #4a90e2;
        color: white;
        padding: 25px;
    }
    
    .card-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .card-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .main-card {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .card-body-custom {
        padding: 30px;
    }
    
    /* File Upload Area - Full Width */
    .file-input-custom-large {
        border: 3px dashed #e5e7eb;
        border-radius: 16px;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #fafafa;
        cursor: pointer;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .file-input-custom-large:hover {
        border-color: #4a90e2;
        background: #f8fafc;
        transform: translateY(-2px);
    }

    .file-input-custom-large.dragover {
        border-color: #4a90e2;
        background: rgba(74, 144, 226, 0.05);
    }

    .file-input-content {
        max-width: 500px;
    }

    .file-name-display {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 600;
        color: #2e7d32;
        display: inline-block;
    }

    /* Option Cards */
    .option-card {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 100%;
        transition: all 0.3s;
        border: 1px solid #f1f5f9;
    }
    
    .option-card:hover {
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        transform: translateY(-3px);
        border-color: #e2e8f0;
    }
    
    /* Form Controls */
    .form-select-custom {
        width: 100%;
        padding: 14px 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 15px;
        background-color: #ffffff;
        transition: all 0.3s;
    }
    
    .form-select-custom:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        outline: none;
    }
    
    .form-check-input:checked {
        background-color: #4a90e2;
        border-color: #4a90e2;
    }
    
    /* Buttons */
    .btn-custom-primary {
        background-color: #4a90e2;
        border: none;
        padding: 14px 35px;
        font-size: 16px;
        border-radius: 8px;
        color: white;
        transition: all 0.3s;
        font-weight: 600;
    }
    
    .btn-custom-primary:hover {
        background-color: #3a7bc8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-custom-secondary {
        background-color: #6b7280;
        border: none;
        padding: 14px 35px;
        font-size: 16px;
        border-radius: 8px;
        color: white;
        transition: all 0.3s;
        font-weight: 600;
    }
    
    .btn-custom-secondary:hover {
        background-color: #4b5563;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Form Labels and Text */
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        display: block;
        font-size: 15px;
    }
    
    .form-text-custom {
        color: #6b7280;
        font-size: 13px;
        margin-top: 8px;
        font-style: italic;
    }
    
    .form-text-custom-small {
        color: #6b7280;
        font-size: 12px;
        margin-top: 6px;
        font-style: italic;
    }
    
    /* Info Alert */
    .info-alert {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #bae6fd;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    /* Table Styling */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table-custom th {
        background-color: #f8fafc;
        padding: 15px;
        font-weight: 600;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .table-custom td {
        padding: 15px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    /* Badge Styles */
    .badge-custom {
        font-size: 0.75rem;
        padding: 0.5rem 0.8rem;
        border-radius: 12px;
        margin: 0.1rem;
        font-weight: 500;
    }

    .badge-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .badge-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .badge-info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .badge-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .result-card {
        background-color: #ffffff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-top: 20px;
    }

    @media (max-width: 768px) {
        .card-body-custom {
            padding: 25px;
        }
        
        .card-header-custom {
            padding: 25px 20px;
        }
        
        .card-title {
            font-size: 1.6rem;
        }
        
        .btn-custom-primary,
        .btn-custom-secondary {
            width: 100%;
            margin-bottom: 12px;
            margin-right: 0 !important;
        }
        
        .file-input-custom-large {
            padding: 2rem 1rem;
            min-height: 150px;
        }
        
        .option-card {
            padding: 20px;
            margin-bottom: 15px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Batch specific JavaScript
    $(document).ready(function() {
        console.log('ðŸš€ Batch Analysis Initialized');

        // File input handling
        $('#batchSentimen').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                $('#fileName').html(`<i class="fas fa-file-csv me-2"></i>${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                $('#fileDropArea').addClass('border-success');
            }
        });

        // Clear form button
        $('#clearFormBtn').on('click', function() {
            Swal.fire({
                title: 'Bersihkan Form?',
                text: 'Semua input dan file yang dipilih akan dihapus.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Bersihkan!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#batchSentimen').val('');
                    $('#fileName').empty();
                    $('#model').val('');
                    $('#perluasan').val('');
                    $('#fileDropArea').removeClass('border-success');
                    showTemporaryAlert('success', 'Form dibersihkan!', 'Semua input telah direset.');
                }
            });
        });

        // Drag and drop functionality
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('batchSentimen');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            fileDropArea.classList.add('dragover');
        }

        function unhighlight() {
            fileDropArea.classList.remove('dragover');
        }

        fileDropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                $('#fileName').html(`<i class="fas fa-file-csv me-2"></i>${files[0].name} (${(files[0].size / 1024).toFixed(2)} KB)`);
                $('#fileDropArea').addClass('border-success');
            }
        }

        // Form submission
        $('#batchForm').on('submit', function(e) {
            const file = $('#batchSentimen').val();
            const model = $('#model').val();
            const perluasan = $('#perluasan').val();
            
            if (!file) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'File Belum Dipilih',
                    text: 'Harap pilih file CSV untuk dianalisis'
                });
                return;
            }

            if (!model) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Model Belum Dipilih',
                    text: 'Harap pilih model yang akan digunakan'
                });
                return;
            }

            if (!perluasan) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'Opsi Perluasan Belum Dipilih',
                    text: 'Harap pilih opsi perluasan model'
                });
                return;
            }

            // Show loading overlay immediately
            showLoading();
            
            // Disable button to prevent double submission
            $('#prosesSentimen').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Memproses...');
        });

        // If there's an error from backend, hide loading
        {% if error %}
            hideLoading();
            $('#prosesSentimen').prop('disabled', false).html('<i class="fas fa-play-circle me-2"></i> Proses Batch');
        {% endif %}
    });

    // Utility function for temporary alerts
    function showTemporaryAlert(type, title, message) {
        Swal.fire({
            icon: type,
            title: title,
            text: message,
            timer: 3000,
            showConfirmButton: false
        });
    }
</script>
{% endblock %}