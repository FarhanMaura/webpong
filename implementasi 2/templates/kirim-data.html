{% extends "base.html" %}

{% block title %}Kirim Data - Sistem Deteksi Ujaran Kebencian{% endblock %}

{% block header_title %}Hate Speech Detector{% endblock %}
{% block header_subtitle %}Kirim Data untuk Analisis{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Main Form Card -->
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
            <div class="main-card">
                <div class="card-header-custom">
                    <div class="text-center">
                        <h2 class="card-title">
                            <i class="fas fa-upload me-2"></i> Kirim Data
                        </h2>
                        <p class="card-subtitle">
                            Unggah file CSV untuk berkontribusi dalam pengembangan sistem
                        </p>
                    </div>
                </div>
                <div class="card-body-custom">
                    <form
                        action="{{ url_for('kirimData')}}"
                        method="POST"
                        enctype="multipart/form-data"
                        id="uploadForm"
                    >
                        {{ form.csrf_token }}

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-csv"></i>
                                Pilih File CSV
                            </label>
                            <div class="file-input-custom" id="fileDropArea">
                                <i
                                    class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"
                                ></i>
                                <h5 class="text-primary">
                                    Drop file di sini atau klik untuk memilih
                                </h5>
                                <p class="text-muted mb-2">
                                    Format: CSV dengan data yang relevan
                                </p>
                                <input
                                    class="d-none"
                                    type="file"
                                    name="fileKirim"
                                    id="fileKirim"
                                    accept=".csv"
                                    required
                                />
                                <button
                                    type="button"
                                    class="btn-custom-secondary mt-2"
                                    onclick="document.getElementById('fileKirim').click()"
                                >
                                    <i class="fas fa-folder-open me-2"></i>Pilih File
                                </button>
                                <div
                                    id="fileName"
                                    class="mt-2 text-success fw-bold"
                                ></div>
                            </div>
                            <div class="form-text text-muted mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                *Hanya support file dengan format CSV
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button
                                    type="submit"
                                    class="btn-custom-primary"
                                    id="submitBtn"
                                >
                                    <i class="fas fa-upload me-2"></i> Kirim Data
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Success Message -->
                    {% if sukses == '1' %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="success-alert">
                                <div class="d-flex align-items-center">
                                    <i
                                        class="fas fa-check-circle text-success me-3"
                                        style="font-size: 1.5rem"
                                    ></i>
                                    <div class="flex-grow-1">
                                        <strong class="d-block mb-1"
                                            >Data Berhasil Dikirim!</strong
                                        >
                                        <span
                                            >Terima kasih telah berkontribusi dalam
                                            pengembangan sistem deteksi ujaran
                                            kebencian.</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %} 
                    
                    {% if sukses == '0' %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div
                                class="alert alert-danger alert-dismissible fade show"
                                role="alert"
                            >
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error:</strong> Format file tidak didukung.
                                Harap unggah file CSV.
                                <button
                                    type="button"
                                    class="btn-close"
                                    data-bs-dismiss="alert"
                                ></button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Information Card -->
    <div class="row justify-content-center mt-4">
        <div class="col-xl-8 col-lg-10">
            <div class="main-card">
                <div class="card-header-custom">
                    <div class="text-center">
                        <h2 class="card-title">
                            <i class="fas fa-info-circle me-2"></i> Informasi Pengiriman Data
                        </h2>
                    </div>
                </div>
                <div class="card-body-custom">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>
                                <i class="fas fa-check-circle text-success me-2"></i>Yang Diperbolehkan
                            </h5>
                            <ul class="list-unstyled">
                                <li>
                                    <i class="fas fa-check text-success me-2"></i> File format CSV
                                </li>
                                <li>
                                    <i class="fas fa-check text-success me-2"></i> Data teks yang relevan
                                </li>
                                <li>
                                    <i class="fas fa-check text-success me-2"></i> Struktur kolom yang konsisten
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>
                                <i class="fas fa-times-circle text-danger me-2"></i>Yang Tidak Diperbolehkan
                            </h5>
                            <ul class="list-unstyled">
                                <li>
                                    <i class="fas fa-times text-danger me-2"></i> File selain CSV
                                </li>
                                <li>
                                    <i class="fas fa-times text-danger me-2"></i> Data yang tidak relevan
                                </li>
                                <li>
                                    <i class="fas fa-times text-danger me-2"></i> File corrupt atau rusak
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> Pastikan file CSV Anda memiliki struktur yang jelas dan data yang relevan untuk analisis ujaran kebencian.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .file-input-custom {
        border: 2px dashed #e5e7eb;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #fafafa;
        cursor: pointer;
    }

    .file-input-custom:hover {
        border-color: var(--primary);
        background: #f8fafc;
    }

    .file-input-custom.dragover {
        border-color: var(--primary);
        background: rgba(59, 130, 246, 0.05);
    }

    .success-alert {
        background: var(--gradient-glass);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 16px;
        border-left: 4px solid var(--success);
        padding: 1.2rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Kirim Data specific JavaScript
    $(document).ready(function() {
        console.log('ðŸš€ Data Upload Page Initialized');

        // File input handling
        $('#fileKirim').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file extension
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Format File Tidak Didukung',
                        text: 'Harap pilih file dengan format CSV.',
                        confirmButtonColor: '#3b82f6'
                    });
                    $(this).val('');
                    $('#fileName').html('');
                    $('#fileDropArea').removeClass('border-success');
                    return;
                }

                $('#fileName').html(`<i class="fas fa-file-csv me-2"></i>${file.name} (${formatFileSize(file.size)})`);
                $('#fileDropArea').addClass('border-success');
            }
        });

        // Drag and drop functionality
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileKirim');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            fileDropArea.classList.add('dragover');
        }

        function unhighlight() {
            fileDropArea.classList.remove('dragover');
        }

        fileDropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const file = files[0];

                // Check file extension
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Format File Tidak Didukung',
                        text: 'Harap gunakan file dengan format CSV.',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                fileInput.files = files;
                $('#fileName').html(`<i class="fas fa-file-csv me-2"></i>${file.name} (${formatFileSize(file.size)})`);
                $('#fileDropArea').addClass('border-success');
            }
        }

        // Form submission
        $('#uploadForm').on('submit', function(e) {
            const file = $('#fileKirim').val();

            if (!file) {
                e.preventDefault();
                Swal.fire({
                    icon: 'warning',
                    title: 'File Belum Dipilih',
                    text: 'Harap pilih file CSV untuk diunggah.',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }

            // Show loading overlay immediately
            showLoading();

            // Disable button to prevent double submission
            $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Mengunggah...');
        });

        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Auto-hide success message after 5 seconds
        {% if sukses == '1' %}
        setTimeout(() => {
            $('.success-alert').fadeOut();
        }, 5000);
        {% endif %}
    });
</script>
{% endblock %}